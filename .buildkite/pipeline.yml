steps:
  - label: Plan Dev
    commands:
      - bash ./tg-plan.sh dev
    artifact_paths:
      - "dev/terraform.tfplan"
      - "lambda.zip"

  - label: Plan Live
    commands: 
      - bash ./tg-plan.sh live
    artifact_paths:
      - "live/terraform.tfplan"
      - "lambda.zip"

  - wait

  - label: Apply Dev
    commands:
      - buildkite-agent artifact download "dev/terraform.tfplan" "dev"
      - buildkite-agent artifact download "lambda.zip" . --step "Plan Dev"
      - bash ./tg-apply.sh dev

  - wait

  - label: Apply Live
    commands: 
      - buildkite-agent artifact download "live/terraform.tfplan" "live"
      - buildkite-agent artifact download "lambda.zip" . --step "Plan Live"
      - bash ./tg-apply.sh live
